# Generated by Array CLI - https://github.com/posthog/array
# Blocks PRs until their downstack dependencies are merged

name: Stack Check

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  pull_request_target:
    types: [closed]

jobs:
  check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check stack dependencies
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const baseBranch = pr.base.ref;
            const trunk = ['main', 'master', 'develop'];

            if (trunk.includes(baseBranch)) {
              console.log('✓ Base is trunk, no dependencies');
              return;
            }

            async function getBlockers(base, visited = new Set()) {
              if (trunk.includes(base) || visited.has(base)) {
                return [];
              }
              visited.add(base);

              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${base}`
              });

              if (prs.length === 0) {
                return [];
              }

              const blocker = prs[0];
              const upstream = await getBlockers(blocker.base.ref, visited);
              return [{ number: blocker.number, title: blocker.title }, ...upstream];
            }

            const blockers = await getBlockers(baseBranch);

            if (blockers.length > 0) {
              const list = blockers.map(b => `#${b.number} (${b.title})`).join('\n  - ');
              core.setFailed(`Blocked by:\n  - ${list}\n\nMerge these PRs first (bottom to top).`);
            } else {
              console.log('✓ All dependencies merged, ready to merge');
            }

  recheck-dependents:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Trigger recheck of dependent PRs
        uses: actions/github-script@v7
        with:
          script: |
            const mergedBranch = context.payload.pull_request.head.ref;

            const { data: dependentPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: mergedBranch,
              state: 'open'
            });

            for (const pr of dependentPRs) {
              console.log(`Re-checking PR #${pr.number}`);

              // Update base to main since the branch will be deleted
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                base: 'main'
              });
            }
